
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../images/" rel="prev"/>
<link href="../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.1.5" name="generator"/>
<title>Path finding - Gentse rol van het wc</title>
<link href="../../assets/stylesheets/main.7a7fce14.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.a0c5b2b5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="blue" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Gentse rol van het wc" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Gentse rol van het wc">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Gentse rol van het wc
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Path finding
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="blue" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="blue" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="grey" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg>
</label>
</form>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Gentse rol van het wc" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Gentse rol van het wc">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    Gentse rol van het wc
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        Collectie van de Gentenaar: Gentse rol van het wc
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Tech walkthrough
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Tech walkthrough
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../image%20conversion/">
        Image conversion
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../images/">
        Images
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<a class="md-nav__link md-nav__link--active" href="./">
        Path finding
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1>Path finding</h1>
<p>Idee was startpunt te kiezen, sprong in de tijd maken en een zekere rang behouden. In die range kijken of er matches zijn.</p>
<p>Probleem 1: datums in de stream stonden niet mooi en met vreemde karakters ==&gt; dit opkuisen</p>
<pre><code class="language-python">def convert_column_first_year_via_regex(self):  
    """  
    convert_column_first_year_via_regex is a function that formats the "converted_creation_date" column in the pd dataframe to something readable    
    """    
    res = self.df[self.time_col].str.extract(r"([\d+]{4})").squeeze()  
    self.df.insert(10, self.clean_time_col, pd.to_numeric(res), True)
</code></pre>
<p>Eerste naieve testcase: ervan uitgaan dat er voldoende data is en kijken of ik, met voldoende tussenstappen (= # wc rol velletjes) voldoende afbeeldingen vind op x afstand en met een link tussen elkaar.</p>
<ul>
<li>Hoe de link zoeken? Lemmatization vs stemming van geselecteerde kolommen</li>
</ul>
<p>%%todo: zet tekening van voorbeeld erbij (print statement)%%
x afstand: eerst op basis van tijd. Wat bleek: data niet uniform genoeg verspreid en tijd lijkt moeilijke metric.
Oplossing: laat tijd los! sorteren van alle entries op basis van tijd, maar dan gewoon sprong maken in de lijst met iedere keer een specifieke afstand en range. Dit komt ongeveer overeen met rekening te houden met de tijdsdistributie en toch te denken in tijd, maar veel gemakkelijker te implementeren.</p>
<p>van</p>
<pre><code class="language-python">def find_indices_in_time_range(self, origin_year: int, time_distance: int, time_spread: int) -&gt; (bool, list[int]):  
    new_origin = origin_year + time_distance  
    new_time_range = [new_origin - time_spread,  
                      new_origin + time_spread]  
    bool_array = self.df.index[  
        (new_time_range[0] &lt;= self.df[self.clean_time_col]) &amp; (self.df[self.clean_time_col] &lt;= new_time_range[1])]  
    if len(bool_array) &gt; 0:  
        res = bool_array.values.tolist()  
        res_bool = True  
    else:  
        res = None  
        res_bool = False  
    return res_bool, res
</code></pre>
<p>waar we in tijdstappen dachten naar:</p>
<pre><code class="language-python">def 
</code></pre>
<p>Nu hebben we een forward motion die rekening houdt met de distributie ifv de tijd, om een path te vinden moeten we een boomstructuur aanmaken, want het is niet gezegd dat we altijd connecties gaan vinden en af en toe moeten we een tak verlaten en een andere tak uitproberen om tot op het einde te geraken! ==&gt; backward motion</p>
<p>Afbeeldingen: de link downloaden: blijkt bij relatief wat afbeeldingen krijg ik geen afbeelding?</p>
<pre><code class="language-python">def get_image_uri(self, img_id) -&gt; str:  
    iiif_manifest = "https://api.collectie.gent/iiif/presentation/v2/manifest/{}:{}".format(self.institute, img_id)  
    try:  
        response = urlopen(iiif_manifest)  
    except ValueError:  
        print('no image found')  
    except HTTPError:  
        print('no image found')  
    else:  
        data_json = json.loads(response.read())  
        image_uri = data_json["sequences"][0]['canvases'][0]["images"][0]["resource"]["@id"]  
        return image_uri
def get_image_list_from_tree(self):  
    # we pick the rows from our dataframe which were chose  
    index_list = self.df_tree[self.df_tree["chosen"] == True].index  
    # based on these indexes we pick the data from within our original dataframe  
    df_list = self.df.iloc[self.df.index.isin(index_list)]  
    # we make a list of the objectnumbers, as they are needed to retrieve images  
    object_id_list = df_list["objectnumber"].values  
    img_list = list(map(lambda x: self.get_image_uri(x), object_id_list))  
    for i in img_list:  
        print(i)  
    print(len(img_list))
</code></pre>
<p>Got me on a random occasion only 12 out of 50 results. Not good...</p>
<p>Plan van aanpak: bij het bouwen van de tree reeds rekening houden met het resultaat van get_image_uri!</p>
<p>Nu wordt alles wel heel traag (serieel alle uri's opvragen), dus gaan we threaded werken!</p>
<p>Van </p>
<pre><code class="language-python">def find_overlap_in_series(self, origin, indexes) -&gt; (bool, list[dict]):  
    """  
    @rtype: object  
    @param origin:    @param indexes:    """  
    print("origin:")  
    print(self.df_row(origin))  
    res = list()  
    res_found = False  

    for i in indexes:  
        if i == origin:  
            continue  
        # print(self.df_row(i))  
        overlap_found, overlap_list, img_uri = self.find_overlap(origin, i)  
        if overlap_found:  
            print(Fore.GREEN)  
            print(overlap_list)  
            res.append({"index": i, "res": overlap_list, "img_uri": img_uri})  
            res_found = True  
        else:  
            # print(Fore.RED + "nothing found")  
            continue  
        print(Style.RESET_ALL)  
    return res_found, res
</code></pre>
<p>Naar threaded:</p>
<pre><code class="language-python">
def find_overlap_threaded_in_series(self, origin, indexes) -&gt; (bool, list[dict], list[str]):  
    """  
    TODO not satisfied with this, not functionally written!  
    @rtype: object  
    @param origin: the index in the original dataframe for which we're looking for childs in &lt;indexes&gt; with a textual overlap    @param indexes: the indexes of possible children    """  
    print("origin:")  
    print(self.df_row(origin))  
    res = list()  
    res_found = False  

    # we'll multithread the find_overlap function to speed things up  
    que = Queue()  
    threads_list = list()  
    for i in indexes:  
        if i == origin:  
            continue  
        t = Thread(target=lambda q, arg1, arg2: q.put(self.find_overlap(arg1, arg2)), args=(que, origin, i))  
        t.start()  
        threads_list.append(t)  
    for t in threads_list:  
        t.join()  
    while not que.empty():  
        overlap_found, overlap_list, img_uri, index = que.get()  
        if overlap_found:  
            print(Fore.GREEN)  
            print(overlap_list)  
            res.append({"index": index, "res": overlap_list, "img_uri": img_uri})  
            res_found = True  
        else:  
            # print(Fore.RED + "nothing found")  
            continue  
        print(Style.RESET_ALL)  
    return res_found, res
</code></pre>
<p>Now, my algorithm is basically:
- You have a startnode
- Find all indices we want to evaluate
- Find all childs based on the indices which have a textual overlap with our startnode
- choose one of them as a new startnode
    - If no child nodes are to be found, switch the new startnode</p>
<p>As this takes a long time, perhaps it's faster for future reference to NOT choose the new startnode, yet search childs with overlaps for all nested childs. This implicates:
- more memory usage
- small rewriting part (not choosing one branch + keeping track of the parent)
- if the database is renewed, entire process needs to be redone.</p>
<p>So I've rewritten my flow for easier reuse:
- instead of finding a unique path and only saving this path towards the end
- I build the entire tree structure
- and find a possible path afterwards
- This way making it possible to recuperate the builded tree structure.
As I only keep a link to the images, I don't have this huge memory bounty.</p>
<p>Now, after having some hassles rewriting the code in threads. It takes a <strong>long</strong> time to make the tree structure. That made me think that I check often for the same entry if there's an image present as they appear in different branches. Thus, I'll rewrite the code again to add the uri, if available, to the original dataframe. Then I don't need to have so many requests (which is the bottleneck, together with my sense of patience)</p>
<p>I now preprocess the data to first go through all images and find their URI, if there's none I don't keep them. 
My initial plan was to process all data into a tree, yet after running an entire night I came to next conclusion: it's becoming way to large and slow. I need 50 layers, by morning I had 9 (with 1000 threads in parallel, and a spread of 3):</p>
<ul>
<li>layer 1: 1 id to check @ 22:25:34</li>
<li>layer 2: 5 ids to check</li>
<li>layer 3: 30 ids to check</li>
<li>layer 4: 150 ids to check</li>
<li>layer 5: 738 ids to check</li>
<li>layer 6: 3947</li>
<li>layer 7: 19849</li>
<li>layer 8: 94446</li>
<li>layer 9: 444545  (400000 @ 08:35:35) ==&gt; I'm not that patient!</li>
</ul>
<p>each 1000 threads took approx 2 minutes at layer 9. Perhaps my dataframe is becoming too large to be efficient... At layer 8 it was about 20 seconds...</p>
<p>So I went for again a different approach:
- first check for each entry if there's an image present as well as a useful date. Other entries I drop.
    - Especially the image present gave a huge dropout:
        - for dmg: out of 9142 ids, we got next HTTP errors: {'403': 1245, '404': 6789, '502': 18}
        - in DMG there are some weird object ids: <code>/iiif/presentation/v2/manifest/dmg:DES. 1995.16_0-2</code> what's the space doing there? the object can't be found + throws an error 
        - for hva: <code>of 8574 ids, we got next HTTP errors: {'403': 9, '404': 6700, '502': 2}</code></p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../assets/javascripts/bundle.407015b8.min.js"></script>
<script src="../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</body>
</html>